- name: Install PM2 globally
  npm:
    name: pm2
    state: present
    global: yes

- name: 1. Find the PID listening on port {{ app_port }}
  ansible.builtin.shell:
    # Use lsof to find the PID for the specified port (TCP) and extract only the PID (column 2)
    cmd: "sudo lsof -t -i tcp:{{ app_port }}" 
  register: pid_result
  changed_when: false
  failed_when: pid_result.rc not in [0, 1] # lsof returns 1 if nothing is found (which is OK)

- name: 2. Kill the existing process if a PID was found
  ansible.builtin.command:
    cmd: "kill -9 {{ pid_result.stdout_lines | first }}" 
  when: pid_result.stdout_lines | length > 0
  register: kill_result

- name: Start the application with PM2
  shell: pm2 start server.js --name theepicbook -f
  args:
    chdir: /home/ubuntu/theepicbook
  register: pm2_start_result
